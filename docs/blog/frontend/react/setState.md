# 关于 React 中的 setState

## 为什么使用 setState

开发中我们并不能直接通过修改 state 的值来让界面发生更新：

- 因为我们修改了 state 之后，希望 React 根据最新的 State 来重新渲染界面，但是这种方式的修改 React 并不知道数据发生了改变;
- React 并没有实现类似于 Vue2 中的 Object.defineProperty 或者 Vue3 中的 Proxy 的方式来监听数据的变化;
- 我们必须通过 setState 来告知 React 数据已经发生了变化;

## 为什么 setState 设计为异步呢?

- setState 设计为异步,可以显著的提升性能;
  - 如果每次调用 setState 都进行一次更新,那么意味着 render 函数会被频繁调用,界面重新渲染,这样效率是很低的;
  - 最好的办法应该是获取到多个更新,之后进行批量更新;
- 如果同步更新了 state,但是还没有执行 render 函数,那么 state 和 props 不能保持同步;
  - state 和 props 不能保持一致性,会在开发中产生很多的问题;

## setState 不一定是异步的

- 在 setTimeout 中的更新
- 原生 dom 事件

也就意味着：

1. 在组件生命周期或 React 合成事件中，setState 是异步的
1. 在 setTimeout 或原生 dom 事件中，setState 是同步的

## setState 原理

在 React 中，setState 是一个用来更新组件状态的核心方法。调用 setState 后，React 会进行一系列操作来更新组件的 UI，这个过程与 React 的虚拟 DOM、Fiber 架构以及调度机制密切相关。下面详细讲解 setState 的执行过程及其背后的原理。

1. **调用 setState**

   当 setState 被调用时，React 并不会立即更新组件的状态和重新渲染组件。它将新的状态合并到当前组件的状态对象中，并将更新操作放入更新队列。这一设计是为了优化性能，通过批量处理多个状态更新，减少不必要的渲染。

2. **合并状态**

   setState 通常是将传入的部分状态与组件的当前状态进行浅合并，并不替换整个状态对象。这种合并行为使得开发者可以只更新状态的一部分，而不影响其他部分的数据。

3. **标记更新和 Fiber 节点**

   - 每个组件实例对应一个 Fiber 节点。当 setState 被调用时，React 会将该 Fiber 节点标记为“需要更新”。
   - 此时，React 会将当前组件及其子组件的更新任务记录下来，并加入到调度器（Scheduler）中，等待合适的时机去执行渲染。

4. **调度更新**

   React 使用调度器来批量调度和优先级调度更新任务。调度器基于任务的优先级来决定哪些更新应被立即执行，哪些更新可以延后或中断（如用户输入的事件处理需要更高的优先级）。

   - 同步更新：在事件处理程序或生命周期方法中调用 setState 时，React 会尝试在批处理的基础上执行同步更新。
   - 异步更新：如果更新发生在 Promise 或其他异步代码中，React 会将它们视为低优先级任务，并异步调度这些更新。

5. **Fiber Reconciliation（协调过程）**

   在更新被调度并开始执行时，React 进入协调阶段（Reconciliation）。这是 React 中的一个核心算法，它比较当前 Fiber 树（旧的虚拟 DOM 树）和更新后的新 Fiber 树（新的虚拟 DOM 树），以找出变化，并生成最小的更新补丁。

   - React 会从根节点开始，递归地遍历每个节点，并对比新旧虚拟 DOM。如果发现有变化，React 会标记对应的 Fiber 节点。
   - 这个过程会构建一个新的虚拟 DOM 树，同时标记哪些节点需要更新、删除或添加。

6. **渲染与提交阶段**

   React 的 Fiber 架构将更新分为两个阶段：

   - 渲染阶段：Fiber 树的构建和 Diff 操作都是在这一阶段完成的。这个阶段是可以被中断和优先调度的，因此 React 能够处理高优先级的任务（如用户输入）而不中断。
   - 提交阶段：当 Fiber 树构建完成后，React 会进入提交阶段。这一阶段是同步的，它将计算出的最小更新补丁应用到真实的 DOM 上。React 会遍历 Fiber 树并更新那些被标记的节点，从而完成最终的 DOM 更新和渲染。

7. **重新渲染组件**

   一旦 DOM 被更新，React 会再次调用组件的 render 方法，以反映更新后的状态。同时，如果组件有子组件，React 也会依次对它们进行渲染。
   总结
   当 setState 被调用时，React 主要经历了以下过程：

   - 状态合并：合并新的部分状态。
   - 任务调度：根据优先级，将更新任务加入调度器。
   - 协调过程：使用 Fiber 架构和 Diff 算法比较新旧虚拟 DOM 树，计算出最小的更新补丁。
   - DOM 更新：在提交阶段，将计算出的更新应用到真实 DOM 上，并触发组件重新渲染。
     React 的这一机制使得 setState 可以高效地处理组件更新，同时优化性能，避免不必要的渲染和更新操作。

8. **总结**

   当 setState 被调用时，React 主要经历了以下过程：

   - 状态合并：合并新的部分状态。
   - 任务调度：根据优先级，将更新任务加入调度器。
   - 协调过程：使用 Fiber 架构和 Diff 算法比较新旧虚拟 DOM 树，计算出最小的更新补丁。
   - DOM 更新：在提交阶段，将计算出的更新应用到真实 DOM 上，并触发组件重新渲染。
     React 的这一机制使得 setState 可以高效地处理组件更新，同时优化性能，避免不必要的渲染和更新操作。
